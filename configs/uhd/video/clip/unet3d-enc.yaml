# ==== Preprocessing ==== #
preproc_name: chunked

data_root: /mnt/tsukuyomi/uhd-eeg/
# ica_data_root: /home/sensho/brain2face/driving_ica/

segment_in_preproc: True

start_subj: 0
end_subj: 22

seq_len: 3 # segment length in seconds

# ---- Face ---- #
fps: 30

face_extractor:
  mode: mesh
  output_size: 256
  eyes_dist_mult: 4
  movement_alert_thresh: 50 # px

# ---- Brain ---- #
num_channels: 128
brain_filter_low: 1.0 # Hz
brain_filter_high: 60 # Hz
brain_orig_sfreq: 250 # Hz
brain_resample_sfreq: 120 # Hz
clamp_lim: 20 # values after robust scaling
baseline_ratio: 0.2 # ratio compared to segment length
# shift_brain: False
# shift_len: 150 # ms

eeg_load_bufsize: 1000 # samples

# ==== Training ==== #
project_name: nd_uhd_clip
train_name: unet3d
debug: False

dataset: UHD

montage_path: brain2face/utils/montages/electrodes_uhd.xml
layout: ch_locations_2d

F: 512 # CLIP embedding dimension

vision:
  # type: dynamic # static (image) or dynamic (video)
  pretrained: False # There is no pretrained CLIP model for video
  model: Unet3DEncoder
  pretrained_model: ViT-B/32 # Used if pretrained is True
  resample_nsamples: 90 # 16 FIXME: hard-coded
  reduction: none # none / mean / extract

vision_encoder:
  image_size: 128
  # patch_size: 32
  num_frames: ${vision.resample_nsamples}
  dim: ${F}
  num_layers: 3
  in_channels: 3
  init_conv_dim: 16

# Brain encoder
reduce_time: True # This parameter is for models, not for preprocessing or dataclass.
D1: 270
D2: 320
K: 32
d_drop: 0.3 # Channel distance for spatial dropout
# NOTE: setting these 2 is the key that BrainEncoder downsamples EEG from 120Hz to 30Hz
final_ksize: 2
final_stride: 2
head_activation: True
time_multiplier: 1
ksizes:
  conv_block: 3
biases:
  conv_block: True
  conv_subj_sa: True
  linear_reduc_time: True

split: deep # shallow / deep / subject_random / subject_each
train_ratio: 0.8
batch_size: 64
lr: 0.002
lr_scheduler: multistep # cosine or multistep
lr_multistep_mlstns: [0.4, 0.6, 0.8, 0.9]
lr_step_gamma: 0.5
epochs: 500
reduction: mean
init_temperature: 5.0

accum_grad: False

chance: False

test_with_whole: False # It is not possible to test with whole for video (CPU memory)

num_workers: 4

seed: 1234

cuda_id: 1

sweep_count: 1
sweep_config:
  method: grid
  metric:
    name: test_top10_acc
    goal: maximize
  parameters:
    d_drop:
      values: [0.1]

# ==== Evaluation ==== #
eval:
  d_drop: 0.3

as_h5: True
for_webdataset: False